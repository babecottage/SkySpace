---
import pkg from '@atproto/api'
const { BskyAgent } = pkg

import ProfileCard from "../../components/ProfileCard.astro";
import ContactCard from "../../components/ContactCard.astro";
import Layout from "../../layouts/Layout.astro";
import Friends from "../../components/Friends.astro";
import Card from "../../components/Card.astro";

const { handle } = Astro.params;

// FIXME: this should be replaced with server data soon
const customProfile = await Astro.glob('/content/profiles/*.md').then(
  (px) => {console.log(px[0].file); return px.find((p) => p.file.includes(handle!))}
);


const agent = new BskyAgent({
  service: "https://bsky.social",
});

await agent.login({
  identifier: import.meta.env.BSKY_USERNAME!,
  password: import.meta.env.BSKY_PASSWORD!,
});

const profile = await agent
  .getProfile({
    actor: handle!,
  })
  .then((p) => p.data);

const topEight = customProfile?.frontmatter.topEight || [];

const theme = customProfile?.frontmatter.theme || { colors: {} }

---

<Layout title={profile.displayName!}>
  <div class="text-text border-border bg-pageBackground font-mono h-full">
    <div class="grid grid-cols-2 gap-x-4 container mx-auto py-6">
      <div class="flex flex-col gap-y-4">
        <ProfileCard
          displayName={profile.displayName}
          avatar={profile.avatar}
          description={profile.description}
        />
        <!-- <ContactCard displayName={profile.displayName} /> -->
        <Card>
          Bluesky Handle:
          {profile.handle}
        </Card>
          <Card>
            <pre
              class="text-sm overflow-x-scroll">
  {JSON.stringify(profile, null, 2)}
          </pre>
          </Card>
      </div>
      <div class="flex flex-col gap-y-4">
        {customProfile && <Card>
          <!-- <h3 class="text-text">{profile.displayName}â€™s Blurbs</h3> -->
          <customProfile.Content />
        </Card>}

        {customProfile && <Friends data={profile} topEight={topEight || []} />}
      </div>
    </div>
  </div>
</Layout>

<style
  is:global
  define:vars={{
    ...theme.colors,
  }}
>
.bg-pageBackground {
  background: var(--pageBackground);
}
</style>
